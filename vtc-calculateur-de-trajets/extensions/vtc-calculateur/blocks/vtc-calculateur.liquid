<div
    id="vtc-widget"
    class="vtc-widget"
    {% assign vtc_notify_endpoint = block.settings.notify_endpoint_url | strip %}
    {% assign vtc_slack_endpoint = block.settings.slack_endpoint_url | strip %}
    {% assign vtc_effective_endpoint = vtc_notify_endpoint %}
    {% if vtc_effective_endpoint == blank %}{% assign vtc_effective_endpoint = vtc_slack_endpoint %}{% endif %}
    data-notify-endpoint="{% if vtc_effective_endpoint != blank and vtc_effective_endpoint contains 'hooks.slack.com' %}{% elsif vtc_effective_endpoint != blank %}{{ vtc_effective_endpoint }}{% endif %}"
    data-slack-endpoint="{% if vtc_slack_endpoint != blank and vtc_slack_endpoint contains 'hooks.slack.com' %}{% elsif vtc_slack_endpoint != blank %}{{ vtc_slack_endpoint }}{% endif %}"
    data-slack-endpoint-url="{% if vtc_slack_endpoint != blank and vtc_slack_endpoint contains 'hooks.slack.com' %}{% elsif vtc_slack_endpoint != blank %}{{ vtc_slack_endpoint }}{% endif %}"
    {% assign vtc_booking_email_to = block.settings.booking_email_to | strip %}
    data-booking-email-to="{% if vtc_booking_email_to != blank %}{{ vtc_booking_email_to }}{% endif %}"
    data-base-fare-berline="{{ block.settings.base_fare_berline }}"
    data-price-per-km-berline="{{ block.settings.price_per_km_berline }}"
    data-base-fare-van="{{ block.settings.base_fare_van }}"
    data-price-per-km-van="{{ block.settings.price_per_km_van }}"
    data-stop-fee="{{ block.settings.stop_fee }}"
    data-quote-message="{{ block.settings.quote_message | escape }}"
    data-slack-enabled="{{ block.settings.slack_enabled }}"
    {% assign vtc_vehicle_image_berline = block.settings.vehicle_image_berline %}
    {% if vtc_vehicle_image_berline == blank %}{% assign vtc_vehicle_image_berline = block.settings.berline_image %}{% endif %}
    {% assign vtc_vehicle_image_van = block.settings.vehicle_image_van %}
    {% if vtc_vehicle_image_van == blank %}{% assign vtc_vehicle_image_van = block.settings.van_image %}{% endif %}
    {% assign vtc_vehicle_image_autre = block.settings.vehicle_image_autre %}
    {% if vtc_vehicle_image_autre == blank %}{% assign vtc_vehicle_image_autre = block.settings.autre_image %}{% endif %}
    data-vehicle-image-berline="{% if vtc_vehicle_image_berline != blank %}{{ vtc_vehicle_image_berline | image_url }}{% endif %}"
    data-vehicle-image-van="{% if vtc_vehicle_image_van != blank %}{{ vtc_vehicle_image_van | image_url }}{% endif %}"
    data-vehicle-image-autre="{% if vtc_vehicle_image_autre != blank %}{{ vtc_vehicle_image_autre | image_url }}{% endif %}"
    data-berline-img="{% if vtc_vehicle_image_berline != blank %}{{ vtc_vehicle_image_berline | image_url }}{% endif %}"
    data-van-img="{% if vtc_vehicle_image_van != blank %}{{ vtc_vehicle_image_van | image_url }}{% endif %}"
    data-autre-img="{% if vtc_vehicle_image_autre != blank %}{{ vtc_vehicle_image_autre | image_url }}{% endif %}"
>

    <h2 class="vtc-title">VTC Smart Booking</h2>
    <p class="vtc-subtitle">Obtenez une estimation instantan√©e de votre trajet.</p>

    <!-- TYPE DE V√âHICULE -->
    <div class="vtc-section">
        <label class="vtc-label">Type de v√©hicule :</label>
        <div class="vtc-radio-group">
            <label><input type="radio" name="vehicle" value="berline" checked> Berline</label>
            <label><input type="radio" name="vehicle" value="van"> Van 7 places</label>
            <label><input type="radio" name="vehicle" value="autre"> Autre (sur devis)</label>
        </div>
    </div>

    <!-- OPTIONS -->
    <div class="vtc-section">
        <label class="vtc-label">Options :</label>

        <label class="vtc-checkbox">
            <input type="checkbox" id="petOption"> Animal de compagnie (+20 ‚Ç¨)
        </label>

        <label class="vtc-checkbox">
            <input type="checkbox" id="babySeatOption"> Si√®ge b√©b√© (+15 ‚Ç¨)
        </label>

        <label class="vtc-label">Option personnalis√©e :</label>
        <input id="customOption" type="text" placeholder="Ex : plusieurs vans, car, demande sp√©ciale‚Ä¶" class="vtc-input">
    </div>

    <!-- ADRESSES -->
    <div class="vtc-section">
        <div style="display:flex;gap:10px;align-items:center;">
            <input id="start" class="vtc-input" placeholder="Adresse de d√©part" style="flex:1;width:auto;">
            <button type="button" id="geoStartBtn" aria-label="Utiliser ma position" style="padding:10px 12px;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer;">üìç</button>
        </div>
        <input id="end" class="vtc-input" placeholder="Adresse d‚Äôarriv√©e">

        <div id="stops-container"></div>

        <label class="vtc-checkbox" style="display:block;margin-top:10px;">
            <input type="checkbox" id="europeMode">
            √âtendre la recherche √† l‚ÄôEurope
        </label>

        <button type="button" class="vtc-add-stop" onclick="addStopField()">+ Ajouter un arr√™t</button>
    </div>

    <!-- DATE -->
    <div class="vtc-section">
        <label class="vtc-label">Date de prise en charge :</label>
        <input id="pickupDate" type="date" class="vtc-input">
    </div>

    <!-- HEURE -->
    <div class="vtc-section">
        <label class="vtc-label">Heure de prise en charge :</label>
        <input id="pickupTime" type="time" class="vtc-input">
    </div>

    <!-- BOUTON CALCUL -->
    <button type="button" class="vtc-btn" onclick="calculatePrice()">Calculer le prix</button>

    <!-- MAP -->
    <div id="map"
         style="width:100%;height:260px;margin-top:20px;border-radius:12px;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.15);">
    </div>

    <!-- R√âSUM√â TRAJET -->
    <div id="route-summary"
         style="display:none;margin-top:22px;background:#fafafa;padding:18px;border-radius:12px;border:1px solid #e5e5e5;font-family:'Inter',sans-serif;">
    </div>

    <!-- FORMULAIRE COORDONN√âES VISIBLES (B1) -->
    <div id="contact-wrapper" class="vtc-contact" style="display:none;margin-top:22px;">
        <h3 style="font-size:18px;margin-bottom:6px;">Vos coordonn√©es</h3>
        <p style="font-size:14px;opacity:0.8;margin-bottom:12px;">
            Uniquement n√©cessaire pour r√©server / √™tre recontact√©.
        </p>

        <input id="customerName" class="vtc-input" placeholder="Nom et pr√©nom">
        <input id="customerEmail" class="vtc-input" placeholder="Adresse e-mail">
        <input id="customerPhone" class="vtc-input" placeholder="T√©l√©phone">

        <p id="contact-error" style="color:#c00;font-size:14px;margin-top:6px;"></p>

        {% assign privacy_href = shop.policies.privacy_policy.url %}
        {% if privacy_href == blank %}{% assign privacy_href = '#' %}{% endif %}
        {% assign terms_href = shop.policies.terms_of_service.url %}
        {% if terms_href == blank %}{% assign terms_href = '#' %}{% endif %}

        <label class="vtc-checkbox" style="display:block;margin-top:12px;">
            <input type="checkbox" id="termsConsent" required>
            J‚Äôai lu et j‚Äôaccepte les <a href="{{ terms_href }}">Conditions</a> et la <a href="{{ privacy_href }}">Politique de confidentialit√©</a>.
        </label>

        <label class="vtc-checkbox" style="display:block;margin-top:10px;">
            <input type="checkbox" id="marketingConsent">
            J‚Äôaccepte de recevoir des offres/actualit√©s par e-mail/SMS. (facultatif, d√©sinscription possible)
        </label>

        <p id="consent-error" style="color:#c00;font-size:14px;margin-top:6px;"></p>
    </div>

    <!-- PRIX + BOUTON RESERVER -->
    <div id="result-wrapper" style="display:flex;justify-content:space-between;align-items:center;margin-top:22px;">
        <p id="result" class="vtc-result" style="margin:0;"></p>

        <button type="button" id="reserve-btn"
                disabled
                style="
                    padding:16px 26px;
                    background:#000;
                    color:white;
                    border:none;
                    border-radius:10px;
                    font-size:16px;
                    font-weight:600;
                    opacity:0.45;
                    cursor:not-allowed;
                    transition:0.25s ease;">
            R√©server mon trajet
        </button>
    </div>

</div>

{% schema %}
{
  "name": "VTC Smart Booking",
  "target": "section",
  "enabled_on": {
    "templates": ["index", "page", "product"]
  },
  "settings": [
    {
      "type": "text",
      "id": "google_maps_api_key",
      "label": "Google Maps API Key"
        },
        {
            "type": "number",
            "id": "base_fare_berline",
            "label": "Base fare (Berline)",
            "default": 29.99
        },
        {
            "type": "number",
            "id": "price_per_km_berline",
            "label": "Prix par km (Berline)",
            "default": 2.4
        },
        {
            "type": "number",
            "id": "base_fare_van",
            "label": "Base fare (Van)",
            "default": 29.99
        },
        {
            "type": "number",
            "id": "price_per_km_van",
            "label": "Prix par km (Van)",
            "default": 3.5
        },
        {
            "type": "number",
            "id": "stop_fee",
            "label": "Frais par arr√™t",
            "default": 0
        },
        {
            "type": "text",
            "id": "quote_message",
            "label": "Message (Sur devis)",
            "default": "Sur devis ‚Äî merci de nous contacter."
        },
        {
            "type": "text",
            "id": "notify_endpoint_url",
            "label": "Notify endpoint URL (optionnel)",
            "info": "Optionnel : laisser vide pour utiliser l‚ÄôApp Proxy (par d√©faut: /apps/vtc/api/booking-notify). Ne mettez jamais une URL Incoming Webhook Slack (hooks.slack.com) ici : elle serait expos√©e c√¥t√© storefront."
        },
        {
            "type": "text",
            "id": "slack_endpoint_url",
            "label": "Endpoint Slack (optionnel)",
            "info": "Optionnel : laisser vide pour utiliser l‚ÄôApp Proxy (par d√©faut: /apps/vtc/api/slack-booking). Ne mettez jamais une URL Incoming Webhook Slack (hooks.slack.com) ici : elle serait expos√©e c√¥t√© storefront."
        },
        {
            "type": "text",
            "id": "booking_email_to",
            "label": "Email destinataire (optionnel)",
            "info": "Optionnel (non secret) : destinataire de l'email de r√©servation. Si vide, l'app utilise BOOKING_EMAIL_TO (env)."
        },
        {
            "type": "checkbox",
            "id": "slack_enabled",
            "label": "Slack activ√©",
            "default": true
        },
        {
            "type": "image_picker",
            "id": "vehicle_image_berline",
            "label": "Image v√©hicule (Berline)"
        },
        {
            "type": "image_picker",
            "id": "vehicle_image_van",
            "label": "Image v√©hicule (Van)"
        },
        {
            "type": "image_picker",
            "id": "vehicle_image_autre",
            "label": "Image v√©hicule (Autre)"
        },
        {
            "type": "image_picker",
            "id": "berline_image",
            "label": "(Legacy) Image Berline"
        },
        {
            "type": "image_picker",
            "id": "van_image",
            "label": "(Legacy) Image Van"
        },
        {
            "type": "image_picker",
            "id": "autre_image",
            "label": "(Legacy) Image Autre"
    }
  ]
}
{% endschema %}

<script src="{{ 'vtc-booking.js' | asset_url }}" defer></script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ block.settings.google_maps_api_key }}&libraries=places&callback=initAutocomplete" defer></script>

<style>
    .vtc-widget {
        max-width: 650px;
        background: #ffffff;
        padding: 26px;
        border-radius: 14px;
        box-shadow: 0 4px 18px rgba(0,0,0,0.12);
        margin: auto;
        font-family: 'Inter', sans-serif;
    }
    .vtc-label { font-weight:600; margin-bottom:6px; display:block; }
    .vtc-section { margin-bottom:22px; }
    .vtc-input { width:100%;padding:14px;margin:8px 0;border-radius:8px;border:1px solid #ccc;font-size:15px; }
    .vtc-btn {
        width:100%;
        padding:16px;
        font-size:18px;
        font-weight:600;
        background:black;
        color:white;
        border:none;
        border-radius:10px;
        cursor:pointer;
        transition:0.3s;
    }
    .vtc-btn:hover { background:#333; }
    .vtc-add-stop {
        margin-top:10px;
        background:transparent;
        border:none;
        color:#007bff;
        cursor:pointer;
    }
</style>
